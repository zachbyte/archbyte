#!/bin/sh

# Function to extract and format desktop entry
extract_desktop_entry() {
    grep "^Name=" "$1" | head -n 1 | cut -d'=' -f2
}

# Function to extract Exec command
extract_exec() {
    grep "^Exec=" "$1" | head -n 1 | cut -d'=' -f2 | sed 's/%[a-zA-Z]//g'
}

# Search directories for .desktop files
search_dirs="/usr/share/applications $HOME/.local/share/applications"

# Build cache of desktop entries
cache_entries() {
    for dir in $search_dirs; do
        if [ -d "$dir" ]; then
            find "$dir" -name "*.desktop" -type f | while read -r file; do
                # Skip entries with NoDisplay=true
                if ! grep -q "^NoDisplay=true" "$file"; then
                    name=$(extract_desktop_entry "$file")
                    [ -n "$name" ] && echo "$name:$file"
                fi
            done
        fi
    done
}

# Get selection from dmenu
selection=$(cache_entries | sort | dmenu -i -l 20 | cut -d':' -f2)

# Launch the selected application
if [ -n "$selection" ] && [ -f "$selection" ]; then
    exec=$(extract_exec "$selection")
    if [ -n "$exec" ]; then
        eval "$exec" &
    fi
fi
